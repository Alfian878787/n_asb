From d1016466aaa0bd9fc84c01b0a2a110c7d7f0ccc2 Mon Sep 17 00:00:00 2001
From: Hansong Zhang <hsz@google.com>
Date: Thu, 26 Apr 2018 15:50:53 -0700
Subject: [PATCH] DO NOT MERGE Prevent stack overflow in btif_storage

Bug: 73963551
Test: manual
Change-Id: I5f7a583aad150ebf9e3d492181d80ca935c8aa3f
(cherry picked from commit e8d311224277e9db5dc94cb94929125992f546f3)
CVE-2018-9430
---

diff --git a/btif/src/btif_storage.c b/btif/src/btif_storage.c
index 20c519c..56e9dca 100644
--- a/btif/src/btif_storage.c
+++ b/btif/src/btif_storage.c
@@ -235,6 +235,10 @@
                 bt_uuid_t *p_uuid = (bt_uuid_t*)prop->val + i;
                 memset(buf, 0, sizeof(buf));
                 uuid_to_string_legacy(p_uuid, buf);
+                if (strlen(value) + strlen(buf) + 1 > (int) sizeof(value) - 1) {
+                  android_errorWriteLog(0x534e4554, "73963551");
+                  return FALSE;
+                }
                 strlcat(value, buf, size);
                 strlcat(value, " ", size);
             }
